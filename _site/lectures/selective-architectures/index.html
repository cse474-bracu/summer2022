<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Selective architectures | CSE474</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Selective architectures" /><meta name="author" content="Meem Arafat Manab" /><meta property="og:locale" content="en_US" /><meta name="description" content="Simulation methods, model building, random number generator, statistical analysis of results, validation and verification techniques." /><meta property="og:description" content="Simulation methods, model building, random number generator, statistical analysis of results, validation and verification techniques." /><link rel="canonical" href="http://localhost:4000/lectures/selective-architectures/" /><meta property="og:url" content="http://localhost:4000/lectures/selective-architectures/" /><meta property="og:site_name" content="CSE474" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Selective architectures" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Meem Arafat Manab"},"headline":"Selective architectures","description":"Simulation methods, model building, random number generator, statistical analysis of results, validation and verification techniques.","url":"http://localhost:4000/lectures/selective-architectures/","@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/bracu_logo.png"},"name":"Meem Arafat Manab"},"@context":"https://schema.org"}</script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" }, } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"><div class="site-logo"></div></a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="http://localhost:4000/lectures/" class="nav-list-link">Lectures</a><li class="nav-list-item"><a href="http://localhost:4000/paper-reviews/" class="nav-list-link">Paper Reviews</a><li class="nav-list-item"><a href="http://localhost:4000/projects/" class="nav-list-link">Final Projects</a><li class="nav-list-item"><a href="http://localhost:4000/resources/" class="nav-list-link">Resources</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search CSE474" aria-label="Search CSE474" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/lectures/">Lectures</a><li class="breadcrumb-nav-list-item"><span>Selective architectures</span></ol></nav><div id="main-content" class="main-content" role="main"> \[\newcommand{\x}{x_{1:L}} \newcommand{\R}{\mathbb{R}} \newcommand{\sB}{\mathcal{B}} \newcommand{\SelfAttention}{\text{SelfAttention}} \newcommand{\TransformerBlock}{\text{TransformerBlock}} \newcommand{\MoETransformerBlock}{\text{MoETransformerBlock}} \newcommand{\EmbedTokenWithPosition}{\text{EmbedTokenWithPosition}} \newcommand{\AddNorm}{\text{AddNorm}} \newcommand{\FeedForward}{\text{FeedForward}} \newcommand{\MoEFeedForward}{\text{MoEFeedForward}} \newcommand{\BERT}{\text{BERT}} \newcommand{\nl}[1]{\textsf{#1}} \newcommand{\embed}{\stackrel{\phi}{\Rightarrow}}\]<p>Recall from the <a href="../lectures/modeling">modeling lecture</a> that the core interface of a neural language model is an encoder that maps token sequences to contextual embeddings:</p>\[[\nl{the}, \nl{mouse}, \nl{ate}, \nl{the}, \nl{cheese}] \embed \left[\binom{1}{0.1}, \binom{0}{1}, \binom{1}{1}, \binom{1}{-0.1}, \binom{0}{-1} \right].\]<p>GPT-3 is a neural language model that maps a token sequence \(x_{1:L}\) by stacking 96 layers of Transformer blocks:</p>\[\text{GPT-3}(x_{1:L}) = \TransformerBlock^{96}(\EmbedTokenWithPosition(x_{1:L})),\]<p>where each Transformer block applies:</p><ol><li>a <strong>self-attention</strong> layer, which allows each token to talk to each other; and<li>a <strong>feed-forward</strong> layer, which processes each token independently:</ol>\[\TransformerBlock(\x) = \AddNorm(\FeedForward, \AddNorm(\SelfAttention, \x)).\]<p>Previous lectures:</p><ul><li>These <strong>dense Transformer</strong> model architectures are currently the dominant paradigm for developing large language models.<li>But scaling these models up is non-trivial, requiring data, model, and pipeline <strong>parallelism</strong> (see <a href="../lectures/systems">systems</a>).</ul><p>Current state of affairs:</p><ul><li>We are running in to the <strong>limits</strong> of how much more we can scale.<li>As models get larger, they have to be split up across more machines, and <strong>network bandwidth</strong> becomes a bottleneck to training. Example of model parallelism:</ul>\[\text{GPU1}[\text{layer1}, \text{layer2}] \quad\quad\quad \text{GPU2}[\text{layer3}, \text{layer4}] \quad\quad\quad \text{GPU3}[\text{layer5}, \text{layer6}].\]<ul><li>So we need to rethink how to architect large language models if we are to continue to scale up.<li>For dense Transformers, each input uses the same (all) parameters of the language model (175B parameters for GPT-3).<li>Instead, can we have each input use a different (and much smaller) subset of parameters?</ul><p>In this lecture, we will explore two different types of <strong>“selective” architectures</strong>, which raises the ceiling of how big the models can get. In particular, we will discuss:</p><ul><li><strong>Mixture-of-experts</strong>: We create a set of <strong>experts</strong>. Each input activates only a small subset of experts.<ul><li>Intuition: an advisory board of experts, each with different backgrounds (e.g., history, math, science, etc.).</ul></ul>\[\text{input} \quad\quad\Rightarrow\quad\quad \text{expert}_1 \quad \text{expert}_2 \quad \text{expert}_3 \quad \text{expert}_4 \quad\quad\Rightarrow\quad\quad \text{output}.\]<ul><li><strong>Retrieval</strong>: We have have a <strong>store</strong> of raw data. Given a new input, we retrieve the relevant parts of the store and use them to predict the output.<ul><li>Intuition: if someone asks you a question, you issue a web search, and read the resulting documents to produce the answer.</ul></ul>\[\text{store} \quad\quad|\quad\quad \text{input} \quad\quad\Rightarrow\quad\quad \text{relevant data from store} \quad \quad\quad\Rightarrow\quad\quad \text{output}.\]<h2 id="mixture-of-experts"> <a href="#mixture-of-experts" class="anchor-heading" aria-labelledby="mixture-of-experts"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mixture of experts</h2><p><strong>Basics</strong>. The idea of mixture of experts goes back to <a href="http://www.cs.toronto.edu/~fritz/absps/jjnh91.pdf">Jacobs et al. (1991)</a>.</p><p><img src="../images/jacobs-moe.png" alt="Mixture of experts" /></p><p>To introduce the basic idea, suppose we are solving a prediction problem:</p>\[x \in \R^d \Rightarrow y \in \R^d.\]<p>Let us start out by learning a feedforward (ReLU) neural network:</p>\[h_\theta(x) = W_2 \max(W_1 x, 0),\]<p>where the parameters are \(\theta = (W_1, W_2)\).</p><ul><li>However, this function might not be powerful enough to represent the function of interest.<li>We could make the neural network wider or deeper.</ul><p>But the <strong>mixture-of-experts</strong> approach is to:</p><ul><li>Define \(E\) experts.<li>Each expert \(e = 1, \dots, E\) has an embedding \(w_e \in \R^d\).<li>Define the <strong>gating function</strong> as a probability distribution over the \(E\) experts:</ul>\[g_e(x) = \frac{\exp(w_e \cdot x)}{\sum_{e' = 1}^E \exp(w_{e'} \cdot x)}.\]<ul><li>Each expert \(e = 1, \dots, E\) has parameters \(\theta^{(e)} = (W_1^{(e)}, W_2^{(e)})\).<li>Define each <strong>expert function</strong> in terms of the expert-specific parameters:</ul>\[h_{\theta_e}(x) = W_2^{(e)} \max(W_1^{(e)} x, 0).\]<ul><li>Define the final function as a mixture of the experts:</ul>\[f(x) = \sum_{e=1}^E \underbrace{g_e(x)}_\text{gating} \underbrace{h_{\theta_e}(x)}_\text{expert}.\]<p><strong>Example</strong>. Consider \(d = 2\) and each expert being a linear classifier (<a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=6215056">source</a>): <img src="../images/moe-figure.png" alt="MoE figure" /></p><p><strong>Training</strong>. We can learn a mixture-of-experts model by normal backpropagation. Applying the product rule yields:</p>\[\nabla f(x) = \sum_{e=1}^E g_e(x) (\nabla (\log g_e(x)) h_{\theta_e}(x) + \nabla h_{\theta_e}(x)).\]<p>Notice that the gradient is proportional to \(g_e(x)\) and updates both the gating function and the experts.</p><p><strong>Saving compute</strong>.</p><ul><li>Note the gating function \(g(x) = [g_1(x), \dots, g_E(x)]\) is non-zero for each expert. For example:</ul>\[g(x) = [0.04, 0.8, 0.01, 0.15].\]<ul><li><p>As written, the mixture of experts doesn’t save any compute, because a feedforward pass would still have to evaluate each expert, and the backward pass would also have to touch each expert.</p><li>However, if we <strong>approximate</strong> the gating function \(g(x) = [g_1(x), \dots, g_E(x)]\) with \(\tilde g(x) = [\tilde g_1(x), \dots, \tilde g_E(x)]\) which places zero on most experts, then in the forward pass, we only have to evaluate the experts \(e\) with nonzero \(\tilde g_e(x)\) (for both the forward and the backward pass).<li>For example, we might take top 2 experts and renormalize:</ul>\[\tilde g(x) = [0, 0.84, 0, 0.16].\]<p><strong>Balancing experts</strong>.</p><ul><li>Mixture of experts is only effective if all experts pitch in.<li>If only one expert is active (e.g., \(g(x) = [0, 1, 0, 0]\)), then this is a waste.<li>Furthermore, if we end up in this state, then the gradients for the unused experts will be zero, and therefore they will not receive any gradients and improve.<li>Therefore, one of the main considerations in using mixture-of-experts is to ensure that <strong>all the experts are used</strong> across inputs.</ul><p><strong>Parallelism</strong>.</p><ul><li>The mixture-of-experts is very conducive to parallelization.<li>Each expert can occupy a different machine.<li>We compute the approximate gating function \(\tilde g(x)\) centrally.<li>Then we ask only the (sparse) set of machines containing <strong>activated</strong> experts to process \(x\).</ul><h3 id="sparsely-gated-mixture-of-experts-lepikhin-et-al-2021"> <a href="#sparsely-gated-mixture-of-experts-lepikhin-et-al-2021" class="anchor-heading" aria-labelledby="sparsely-gated-mixture-of-experts-lepikhin-et-al-2021"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sparsely-gated mixture of experts (<a href="https://arxiv.org/pdf/2006.16668.pdf">Lepikhin et al. 2021</a>)</h3><ul><li>We now consider how the mixture-of-experts idea can be applied to language modeling.<li>The naive solution would be to have a mixture of 96-layer Transformers, but<ul><li>the gating function would need to somehow need to apply to a sequence; and<li>the combination of experts only happens superficially at the top.</ul><li>Therefore, we will apply the mixture-of-experts idea to:<ul><li>each token and<li>each Transformer block (or every other one).</ul><li>Since the feed-forward layer is independent for each token, we turn each feed-forward network into a <strong>mixture-of-experts (MoE) feed-forward network</strong>:</ul>\[\MoETransformerBlock(\x) = \AddNorm(\MoEFeedForward, \AddNorm(\SelfAttention, \x)).\]<ul><li>Every other Transformer block uses a MoE Transformer block.</ul><p><img src="../images/glam-architecture.png" alt="GLaM architecture" /></p><p>We define the <strong>top-2 experts</strong> approximate gating function as follows:</p><ul><li>Compute the top expert: \(e_1 = \arg\max_e g_e(x)\).<li>Compute the second expert: \(e_2 = \arg\max_{e \neq e_1} g_e(x)\).<li>Always keep top expert and keep the second expert stochastically:<ul><li>Let \(p = \min(2 g_{e_2}(x), 1)\).<li>With probability \(p\), set \(\tilde g_{e_1}(x) = \frac{g_{e_1}(x)}{g_{e_1}(x) + g_{e_2}(x)}\), \(\tilde g_{e_2}(x) = \frac{g_{e_2}(x)}{g_{e_1}(x) + g_{e_2}(x)}\), \(\tilde g_e(x) = 0\) for \(e \not\in \{ e_1, e_2 \}\).<li>With probability \(1 - p\): \(\tilde g_{e_1}(x) = 1\), and \(\tilde g_e(x) = 0\) for \(e \neq e_1\).</ul></ul><p>Notation:</p><ul><li>Let \(B\) be the number of tokens in the batch (across all sequences); usually on the order of millions.<li>Let \(E\) be the number of experts; usually on the order of thousands.<li>Let \(x_1, \dots, x_B\) be the tokens in the batch.</ul><p><strong>Balancing experts</strong>.</p><ul><li>Let \(c_e = \sum_{i=1}^B \mathbf{1}[\tilde g_e(x_i) &gt; 0]\) be the number of times expert \(e\) is selected.<li>Note that after processing a batch, \(\sum_e c_e = B\).<li>If all the experts were balanced, then \(c_e = \frac{B}{E}\).<li><strong>Overflow</strong>: If \(c_e &gt; 2 \frac{B}{E}\), then set \(f(x) = x\) (bypass with residual connection), where \(2\) here is the capacity factor.<li><strong>Auxiliary loss</strong>: We would like to encourage \(c = [c_1, \dots, c_E]\) to close to uniform.<ul><li>We could penalize \(\|c\|_2^2 = \sum_{e=1}^E c_e^2\), but this is not differentiable.<li>Define \(m_e = \sum_{i = 1}^B g_e(x_i)\) (this is the soft version of \(c_e\)).<li>Instead, we add \(\text{load-balancing-loss} = \sum_{e=1}^E m_e c_e\) to the objective function. This way, the gradient will be nonzero through \(m_e\).</ul></ul>\[\text{loss} = \text{negative-log-likelihood} + \lambda \text{load-balancing-loss}.\]<p>For example, we can take \(\lambda = \frac{0.01}{B}\).</p><p><strong>Example</strong>. Here is an example with \(B = 2\) tokens and \(E = 4\) experts:</p>\[g(x_1) = [0.2, 0.6, 0.1, 0.1] \Rightarrow \tilde g(x_1) = [0.25, 0.75, 0, 0]\] \[g(x_2) = [0.1, 0.6, 0.2, 0.1] \Rightarrow \tilde g(x_2) = [0, 0.75, 0.25, 0]\]<p>The counter would be:</p>\[c = [1, 2, 1, 0] \quad\quad\quad\quad m = [0.3, 1.2, 0.3, 0.2]\]<p>We would try to push down on the gating function on expert 2 to discourage its use.</p><h3 id="switch-transformer-fedus-et-al-2021"> <a href="#switch-transformer-fedus-et-al-2021" class="anchor-heading" aria-labelledby="switch-transformer-fedus-et-al-2021"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Switch Transformer (<a href="https://arxiv.org/pdf/2101.03961.pdf">Fedus et al. 2021</a>)</h3><ul><li>Defines the approximate gating function \(\tilde g(x)\) to only be the top-1 expert (to get even more sparsity).<li>Tricks:<ul><li>Does selective casting from FP32 to FP16<li>Smaller parameters for initialization<li>Expert dropout<li>Expert parallelism</ul><li>Trained a 1.6 trillion parameter model<li>Improved pre-training speed compared to T5-XXL (11 billion parameters) by 4x</ul><h3 id="balanced-assignment-of-sparse-experts-base-layers-lewis-et-al-2021"> <a href="#balanced-assignment-of-sparse-experts-base-layers-lewis-et-al-2021" class="anchor-heading" aria-labelledby="balanced-assignment-of-sparse-experts-base-layers-lewis-et-al-2021"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Balanced Assignment of Sparse Experts (BASE) layers (<a href="https://arxiv.org/pdf/2103.16716.pdf">Lewis et al., 2021</a>)</h3><ul><li>BASE defines the approximate gating function \(\tilde g(x)\) to be the result of a joint optimization over all the tokens in the batch.<li>We will assign each token 1 expert, but <strong>load balancing is a constraint</strong> rather than a soft penalty.<li>We define \(a = [a_1, \dots, a_B] \in \{1, \dots, E\}^B\) to be the joint assignment vector.</ul>\[\text{maximize} \sum_{i = 1}^B w_{a_i} \cdot x_i \quad\text{subject to}\quad \forall e: \sum_{i=1}^B \mathbf{1}[a_i = e] = \frac{B}{E}.\]<ul><li>This is a linear program that can be solved efficiently.<li>In practice, we parallelize the linear program.<li><strong>At test time</strong>, just choose the top-1 expert.</ul><p>Experimental setup:</p><ul><li>Sparsely gated MoE (top-2 experts): 52.5B parameters<li>Switch Transformer (top-1 expert): 52.5B parameters<li>BASE (1 jointly optimized expert): 44.4B parameters (1.3B shared parameters, 335M x 128 expert parameters)</ul><p><img src="../images/base-results.png" alt="BASE results" /></p><p>BASE requires more compute to optimize the assignment \(a\), but is more stable.</p><p><strong>Summary and next steps</strong>.</p><ul><li>Switch Transformer (Google) used top-1 expert.<li>BASE (Facebook) used 1 expert per token, but jointly optimized.<li>Neither of these competed with GPT-3. Since then, both Google and Facebook released two most recent high-performing MoE language models that do compete with GPT-3, but interestingly, they are still based on the original simple top-2 experts:<ul><li>GLaM from Google<li>“FacebookMoE” from Facebook</ul></ul><h3 id="generalist-language-model-glam-du-et-al-2021"> <a href="#generalist-language-model-glam-du-et-al-2021" class="anchor-heading" aria-labelledby="generalist-language-model-glam-du-et-al-2021"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generalist Language Model (GLaM) (<a href="https://arxiv.org/pdf/2112.06905.pdf">Du et al. 2021</a>)</h3><p>Specification:</p><ul><li>1.2 trillion parameters (GPT-3 had 175 billion parameters)<li>64 experts (not that many), 64 layers, 32K hidden units<li>Each token activates 95B (8% of 1.2T) of the parameters</ul><p>Other upgrades:</p><ul><li>Created new dataset (GLaM dataset) of 1.6 trillion tokens of webpages, forums, books, news, etc.<li>Relative positional embeddings, Gated linear units, GeLU activation function, RMSNorm (not LayerNorm)<li>Skip weight updates / rollback to earlier checkpoint if encounter NaN/Inf.<li>“With the above tricks carefully implemented, we observe that the training of sparsely activated models at all scales becomes quite stable.”</ul><p>Results:</p><ul><li>1/3 of the cost to train compared to GPT-3<li>Evaluated on same benchmarks as GPT-3 (open-domain question answering, reading comprehension, SuperGLUE, etc.)<li>Achieved better 0-shot and 1-shot performance compared to GPT-3 (especially performant on knowledge-intensive tasks)<li>Note: they did not evaluate in the few-shot, where GPT-3 is stronger</ul><p><img src="../images/glam-results2.png" alt="GLaM results" /> <img src="../images/glam-trivia-qa.png" alt="GLaM results" /></p><p>Results on WinoGender:</p><ul><li>Example: <em>The nurse notified the patient that <strong>{her/his,their}</strong> shift would be ending in an hour.</em><li>GPT-3: 64.2%<li>GLaM: 71.7%<ul><li>“he” examples: 70.8%<li>“she” examples: 72.5%<li>stereotypical examples: 71.7%<li>anti-stereotypical (“gotcha”) examples: 71.7%</ul><li>GLaM has less gender bias (as measured by this benchmark).</ul><h3 id="facebookmoe-artetxe-et-al-2021"> <a href="#facebookmoe-artetxe-et-al-2021" class="anchor-heading" aria-labelledby="facebookmoe-artetxe-et-al-2021"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> FacebookMoE (<a href="https://arxiv.org/pdf/2112.10684.pdf">Artetxe et al., 2021</a>)</h3><p>Setup:</p><ul><li>Trained a 1.1T parameter model<li>512 experts (more than GLaM), 32 layers, 4096 hidden units<li>Trained on 112 billion tokens on webpages, forums, books, news, etc.<li>Strong gains for smaller models, diminishing gains for larger models</ul><p><img src="../images/facebook-moe-results.png" alt="FacebookMoE results" /></p><p>Results on <a href="https://stereoset.mit.edu/explore/dev/">StereoSet</a>:</p><ul><li>Example: <em>The assistant went to work. {She brought her boss coffee., She was valued for her input.}</em><li>Stereotype bias gets worse with increase model size (counterpoint to the GLaM results). <img src="../images/facebook-moe-stereoset.png" alt="FacebookMoE results" /></ul><h3 id="decentralized-mixture-of-experts-ryabinin--gusev-2020"> <a href="#decentralized-mixture-of-experts-ryabinin--gusev-2020" class="anchor-heading" aria-labelledby="decentralized-mixture-of-experts-ryabinin--gusev-2020"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Decentralized mixture-of-experts (<a href="https://arxiv.org/pdf/2002.04013.pdf">Ryabinin &amp; Gusev, 2020</a>)</h3><p>Motivation:</p><ul><li>So far, the mixture-of-experts was motivated purely from a perspective of a <strong>central</strong> organization (e.g., Google or Facebook) scaling up a massive large language model.<li>However, mixture-of-experts naturally suggests a much more radical <strong>decentralization</strong>.<li>The <a href="https://blogs.microsoft.com/ai/openai-azure-supercomputer/">Azure supercomputer cluster</a> used to train GPT-3 costs $250 million.<li>How can we harness the <a href="https://lisbdnet.com/how-many-computers-are-there-in-the-world/">hundreds of millions</a> of consumer PCs?<li><a href="https://foldingathome.org/">Folding@Home</a> is a <strong>volunteer computing</strong> project that leverages volunteers across the world to donate compute to do molecular dynamics simulations.<li>In April 2020, Folding@Home had 700,000 people donate compute producing 2.43 exaFLOPs (GPT-3 requires 350 gigaFLOPs) (<a href="https://www.sciencealert.com/so-many-people-are-running-folding-home-that-it-s-created-the-world-s-biggest-supercomputer">article</a>).<li>The main difference is that molecular dynamics simulations is compute-heavy and doesn’t require network bandwidth.</ul><p>Main considerations:</p><ul><li>Many nodes (\(10^3 \sim 10^6\) heterogeneous PCs)<li>Frequent node failures (5-20% have at least one failure/day)<li>Home-Internet communication bandwidth (100Mbps; compared to 400Gbps for the Azure supercomputer)</ul><p>Distributed hash tables:</p><ul><li>\(N\) nodes<li>A single node needs to talk to \(O(\log N)\) other nodes<li>Used Kademlia DHT protocol (used by BitTorrent and Ethereum)</ul><p><img src="../images/dmoe.png" alt="Decentralized MoE" /></p><p>Experiments from the paper:</p><ul><li>Top-4 experts (256 experts total)<li>Each expert is a Transformer layer<li>Trained a small Transformer LM on 4 GPUs</ul><p><a href="https://arxiv.org/pdf/2106.10207.pdf">Diskin et al., 2021</a>:</p><ul><li>40 volunteers<li>Trained an ALBERT-style masked language model for Bengali<li><a href="https://training-transformers-together.github.io/">Training Transformers Together</a>: anyone can join and contribute compute</ul><p><img src="../images/volunteer-dall-e.png" alt="Volunteer training for DALL-E" /></p><h3 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary</h3><ul><li>Mixture-of-experts: classic idea of applying different <strong>experts</strong> to different inputs<li>Allows for training much <strong>larger</strong> language models (1.1 trillion parameters)<li>Much more <strong>efficient</strong> per input (fewer FLOPs) than dense Transformer models<li>Hard to compare Direct comparisons are still challenging at scale (GPT-3 versus GLaM versus FacebookMoE)<li>Strong implications for <strong>decentralization</strong></ul><h2 id="retrieval-based-models"> <a href="#retrieval-based-models" class="anchor-heading" aria-labelledby="retrieval-based-models"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Retrieval-based models</h2><p>We now turn to another class of language models, <strong>retrieval-based</strong> (or retrieval-augmented, memory-augmented models), that can help us push past the scaling ceiling of a dense Transformer.</p><p><strong>Encoder-decoder</strong>. Let us first focus on sequence-to-sequence tasks using an encoder-decoder framework:</p>\[\text{input } x \quad\Rightarrow\quad \text{output } y\]<p>Example (open-book question answering):</p><ul><li>Input \(x\): <em>What is the capital of Canada?</em><li>Output \(y\): <em>Ottawa</em></ul><p>Recall that <a href="https://arxiv.org/pdf/1910.13461.pdf">BART</a> and <a href="https://arxiv.org/pdf/1910.10683.pdf">T5</a> are examples of encoder-decoder models:</p>\[p(y \mid x)\]<p>that are trained on denoising objectives; for example:</p><ul><li>Input \(x\): Thank you <X> me to your party <Y> week.</Y></X><li>Output \(y\): <X> for inviting <Y> last <Z></Z></Y></X></ul><p><strong>Retrieval</strong>. Let us assume that we have a <strong>store</strong> \(S\), which is a set of sequences (usually, documents or passages).</p>\[S = \{ \nl{Why is the...}, \nl{Thanks for}, ..., \nl{The quick...}, \nl{Stanford...} \}.\]<p>Intuitively, a retrieval-based model generates:</p><ul><li><strong>Retrieve</strong> a relevant sequence(s) \(z\) based on input \(x\).<li><strong>Generate</strong> the output \(y\) given retrieved sequence(s) \(z\) and input \(x\).</ul><p>Example (open-book question answering):</p><ul><li>Input \(x\): <em>What is the capital of Canada?</em><li>Retrieval \(z\): <em>Ottawa is the capital city of Canada.</em><li>Output \(y\): <em>Ottawa</em></ul><p><strong>Nearest neighbors</strong> as a special case:</p><ul><li>\(S\) is the training set.<li>Retrieve the \((x',y') \in S\) whose \(x'\) is most similar to \(x\).<li>Generate \(y = y'\).</ul><h3 id="retrieval-augmented-generation-rag-lewis-et-al-2020"> <a href="#retrieval-augmented-generation-rag-lewis-et-al-2020" class="anchor-heading" aria-labelledby="retrieval-augmented-generation-rag-lewis-et-al-2020"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Retrieval-augmented generation (RAG) (<a href="https://arxiv.org/pdf/2005.11401.pdf">Lewis et al., 2020</a>)</h3><p><img src="../images/rag-architecture.png" alt="RAG" /></p><p>Formally, the RAG-Sequence model is defined as follows:</p>\[p(y \mid x) = \sum_{z \in S} \underbrace{p(z \mid x)}_\text{retriever} \underbrace{p(y \mid z, x)}_\text{generator}.\]<p>In practice, the summation \(z \in S\) is replaced by the <strong>top-k</strong> (analogous to choosing the top 1 or 2 experts for mixture of experts).</p><p><strong>Retriever: Dense Passage Retrieval (DPR)</strong> (<a href="https://arxiv.org/pdf/2004.04906.pdf">Karpukhin et al., 2020</a>).</p>\[p(z \mid x) = \frac{\exp(\BERT_\text{d}(z) \cdot \BERT_\text{q}(x))}{\sum_{z' \in S} \exp(\BERT_\text{d}(z') \cdot \BERT_\text{q}(x))}.\]<ul><li>Considers on passages of 100 words with title of Wikipedia article<li>Trained on query, positive example, negative examples: \((q, p^+, p^-_1, \dots, p^-_n)\) from QA datasets (NaturalQuestions, TriviQA, etc.)<ul><li>Negative passages: random + passages retrieved using BM25 on \(q\) that don’t contain the answer</ul><li>Inference: uses <a href="https://github.com/facebookresearch/faiss">FAISS</a> (Facebook AI Similarity Search)</ul><p><strong>Generator</strong>.</p>\[p(y \mid z, x) = p(y \mid \text{concat}(z, x)).\]<ul><li>Use BART-large (400M parameters) where input is retrieved passage \(z\) concatenated with input \(x\)<li>Recall BART was trained on denoising objectives (e.g., masking) on web, news, books, stories</ul><p><strong>Training</strong>.</p><ul><li>Initialize with BART, DPR (initialized with BERT).<li>Tune \(\text{BART}\) and \(\BERT_\text{q}\).</ul><p><strong>Experiments</strong>.</p><ul><li>Example of RAG-Token on Jeopardy question generation given input <em>Hemingway</em>:</ul><p><img src="../images/rag-example.png" alt="RAG example" /></p><ul><li>Outperforms non-retrieval methods: <img src="../images/rag-results.png" alt="RAG results" /> For comparison, GPT-3 (few-shot): NaturalQuestions (29.9%), WebQuestions (41.5%), TriviaQA (71.2%)</ul><h3 id="retro-borgeaud-et-al-2021"> <a href="#retro-borgeaud-et-al-2021" class="anchor-heading" aria-labelledby="retro-borgeaud-et-al-2021"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> RETRO (<a href="https://arxiv.org/pdf/2112.04426.pdf">Borgeaud et al., 2021</a>)</h3><ul><li>Retrieve based on <strong>chunks</strong> of 32 tokens<li>Store: 2 trillion tokens<li>7 billion parameters (25 times fewer parameters than GPT-3)<li>Use frozen BERT for retrieval (don’t update)<li>Trained on MassiveText (same dataset used to train Gopher)</ul><p>Results:</p><ul><li>Performs very well on language modeling<li>NaturalQuestions accuracy: 45.5% (SOTA is 54.7%)</ul><p><img src="../images/retro-lm-results.png" alt="RETRO language modeling results" /></p><h3 id="discussion"> <a href="#discussion" class="anchor-heading" aria-labelledby="discussion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Discussion</h3><ul><li>The retrieval-based models are highly geared towards knowledge-intensive, question answering tasks.<li>Beyond scalability, retrieval-based models provide <strong>interpretability</strong> and ability to update the store.<li>Unclear whether these models have the same general-purpose capabilities as a dense Transformer.</ul><h2 id="summary-1"> <a href="#summary-1" class="anchor-heading" aria-labelledby="summary-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary</h2><ul><li>In order to scale, need to go beyond dense Transformers.<li>Mixture-of-experts and retrieval-based methods are more efficient.<li>How to design the best, scalable architectures is still an open question.</ul><h2 id="further-reading"> <a href="#further-reading" class="anchor-heading" aria-labelledby="further-reading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Further reading</h2><p>Mixture of experts:</p><ul><li><a href="https://arxiv.org/pdf/1701.06538.pdf">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a>. <em>Noam M. Shazeer, Azalia Mirhoseini, Krzysztof Maziarz, Andy Davis, Quoc V. Le, Geoffrey E. Hinton, J. Dean</em>. ICLR 2017. Trains 137 billion parameter model; mixture of experts (1000 experts) applied convolutionally between LSTM layers.<li><a href="https://arxiv.org/pdf/2006.16668.pdf">GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding</a>. <em>Dmitry Lepikhin, HyoukJoong Lee, Yuanzhong Xu, Dehao Chen, Orhan Firat, Yanping Huang, M. Krikun, Noam M. Shazeer, Z. Chen</em>. ICLR 2020. Trains Transformer for neural machine translation (100 languages) with 600 billion parameters. Use top-2 experts.<li><a href="https://arxiv.org/pdf/2101.03961.pdf">Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</a>. <em>W. Fedus, Barret Zoph, Noam M. Shazeer</em>. 2021. Trains language model, 4x speedup over T5-XXL (13 billion parameters). Use top-1 expert.<li><a href="https://arxiv.org/pdf/2112.06905.pdf">GLaM: Efficient Scaling of Language Models with Mixture-of-Experts</a>. <em>Nan Du, Yanping Huang, Andrew M. Dai, Simon Tong, Dmitry Lepikhin, Yuanzhong Xu, M. Krikun, Yanqi Zhou, Adams Wei Yu, Orhan Firat, Barret Zoph, Liam Fedus, Maarten Bosma, Zongwei Zhou, Tao Wang, Yu Emma Wang, Kellie Webster, Marie Pellat, Kevin Robinson, K. Meier-Hellstern, Toju Duke, Lucas Dixon, Kun Zhang, Quoc V. Le, Yonghui Wu, Zhifeng Chen, Claire Cui</em>. 2021. Trains 1.2 trillion parameter model, 64 experts. Use top-2 experts. Also creates new dataset.<li><a href="https://arxiv.org/pdf/2103.16716.pdf">BASE Layers: Simplifying Training of Large, Sparse Models</a>. <em>M. Lewis, Shruti Bhosale, Tim Dettmers, Naman Goyal, Luke Zettlemoyer</em>. ICML 2021. Solve optimization problem for token-to-expert allocation to balance allocation. Trains 110 billion parameter model.<li><a href="https://arxiv.org/pdf/2112.10684.pdf">Efficient Large Scale Language Modeling with Mixtures of Experts</a>. <em>Mikel Artetxe, Shruti Bhosale, Naman Goyal, Todor Mihaylov, Myle Ott, Sam Shleifer, Xi Victoria Lin, Jingfei Du, Srinivasan Iyer, Ramakanth Pasunuru, Giridhar Anantharaman, Xian Li, Shuohui Chen, H. Akın, Mandeep Baines, Louis Martin, Xing Zhou, Punit Singh Koura, Brian O’Horo, Jeff Wang, Luke Zettlemoyer, Mona Diab, Zornitsa Kozareva, Ves Stoyanov</em>. 2021. Trains 1.1 trillion parameter models. Use top-2 experts (512 experts).<li><a href="https://arxiv.org/pdf/2002.04013.pdf">Towards Crowdsourced Training of Large Neural Networks using Decentralized Mixture-of-Experts</a>. <em>Max Ryabinin, Anton I. Gusev</em>. NeurIPS 2020.<li><a href="https://arxiv.org/pdf/2106.10207.pdf">Distributed Deep Learning in Open Collaborations</a>. <em>Michael Diskin, Alexey Bukhtiyarov, Max Ryabinin, Lucile Saulnier, Quentin Lhoest, A. Sinitsin, Dmitry Popov, Dmitry Pyrkin, M. Kashirin, Alexander Borzunov, Albert Villanova del Moral, Denis Mazur, Ilia Kobelev, Yacine Jernite, Thomas Wolf, Gennady Pekhimenko</em>. 2021.<li><a href="https://arxiv.org/pdf/2112.14397.pdf">Dense-to-Sparse Gate for Mixture-of-Experts</a>. <em>Xiaonan Nie, Shijie Cao, Xupeng Miao, Lingxiao Ma, Jilong Xue, Youshan Miao, Zichao Yang, Zhi Yang, Bin Cui</em>. 2021.</ul><p>Retrieval-based models:</p><ul><li><a href="https://arxiv.org/pdf/2002.08909.pdf">REALM: Retrieval-Augmented Language Model Pre-Training</a>. <em>Kelvin Guu, Kenton Lee, Z. Tung, Panupong Pasupat, Ming-Wei Chang</em>. 2020. Introduces <strong>REALM</strong>.<li><a href="https://arxiv.org/pdf/2005.11401.pdf">Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks</a>. <em>Patrick Lewis, Ethan Perez, Aleksandara Piktus, Fabio Petroni, Vladimir Karpukhin, Naman Goyal, Heinrich Kuttler, M. Lewis, Wen-tau Yih, Tim Rocktäschel, Sebastian Riedel, Douwe Kiela</em>. NeurIPS 2020. Introduces <strong>RAG</strong>.<li><a href="https://arxiv.org/pdf/2112.04426.pdf">Improving language models by retrieving from trillions of tokens</a>. <em>Sebastian Borgeaud, A. Mensch, Jordan Hoffmann, Trevor Cai, Eliza Rutherford, Katie Millican, G. V. D. Driessche, J. Lespiau, Bogdan Damoc, Aidan Clark, Diego de Las Casas, Aurelia Guy, Jacob Menick, Roman Ring, T. Hennigan, Saffron Huang, Lorenzo Maggiore, Chris Jones, Albin Cassirer, Andy Brock, Michela Paganini, Geoffrey Irving, Oriol Vinyals, Simon Osindero, K. Simonyan, Jack W. Rae, Erich Elsen, L. Sifre</em>. 2021. Introduces <strong>RETRO</strong>.</ul><hr><footer> <!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Untitled</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css"><link rel="stylesheet" href="assets/css/style.css"><body><div class="footer-clean"><footer><div class="container"><div class="row justify-content-center"><p class="copyright">Made and Compiled by <a href="https://www.linkedin.com/in/joyanta0/">Joyanta.</a></p><p class="copyright">Department of Computer Science and Engineering, School of Data and Sciences BRAC University © 2023</p></div></div></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script></footer></div></div><div class="search-overlay"></div></div>
